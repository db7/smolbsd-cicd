name: Build and test example in smolBSD VM
on: [push]

env:
  REGISTRY: ghcr.io

jobs:
  smolbsd-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/db7/smolbsd-cicd/example:latest
      options: --privileged
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Tar example
        run: tar cf example.tar example

      - name: Create payload image
        run: scripts/pack-payload.sh payload.img example/run.sh example.tar

      - name: Run payload
        run: scripts/run-payload.sh /smolBSD cicd payload.img

      - name: Unpack payload
        run: scripts/unpack-payload.sh payload.img results

      - name: List files in unpacked image
        run: ls results

      - name: Ensure tests passed
        run: example/check-results.sh results
